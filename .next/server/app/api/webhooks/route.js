"use strict";(()=>{var e={};e.id=877,e.ids=[877],e.modules={11185:e=>{e.exports=require("mongoose")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},32081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},73837:e=>{e.exports=require("util")},77620:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>y,originalPathname:()=>S,patchFetch:()=>k,requestAsyncStorage:()=>h,routeModule:()=>m,serverHooks:()=>w,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>_});var a={};r.r(a),r.d(a,{POST:()=>u});var o=r(95419),s=r(69108),i=r(99678),n=r(57838),d=r(31228),c=r(18237),p=r(78070),l=r(15922);let u=async e=>{try{let t=await e.text(),r=e.headers.get("Stripe-Signature"),a=l.A.webhooks.constructEvent(t,r,process.env.STRIPE_WEBHOOK_SECRET);if("checkout.session.completed"===a.type){let e=a.data.object,t={clerkId:e?.client_reference_id,name:e?.customer_details?.name,email:e?.customer_details?.email},r={street:e?.shipping_details?.address?.line1,city:e?.shipping_details?.address?.city,state:e?.shipping_details?.address?.state,postalCode:e?.shipping_details?.address?.postal_code,country:e?.shipping_details?.address?.country},o=await l.A.checkout.sessions.retrieve(e.id,{expand:["line_items.data.price.product"]}),s=await o?.line_items?.data,i=s?.map(e=>({product:e.price.product.metadata.productId,color:e.price.product.metadata.color||"N/A",size:e.price.product.metadata.size||"N/A",quantity:e.quantity}));await (0,c.P)();let p=new d.Z({customerClerkId:t.clerkId,products:i,shippingAddress:r,shippingRate:e?.shipping_cost?.shipping_rate,totalAmount:e.amount_total?e.amount_total/100:0});await p.save();let u=await n.Z.findOne({clerkId:t.clerkId});u?u.orders.push(p._id):u=new n.Z({...t,orders:[p._id]}),await u.save()}return new p.Z("Order created",{status:200})}catch(e){return console.log("[webhooks_POST]",e),new p.Z("Failed to create the order",{status:500})}},m=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/webhooks/route",pathname:"/api/webhooks",filename:"route",bundlePath:"app/api/webhooks/route"},resolvedPagePath:"C:\\Users\\ASharma\\Documents\\New folder\\borcella_admin-master\\app\\api\\webhooks\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:h,staticGenerationAsyncStorage:g,serverHooks:w,headerHooks:y,staticGenerationBailout:_}=m,S="/api/webhooks/route";function k(){return(0,i.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:g})}},57838:(e,t,r)=>{r.d(t,{Z:()=>i});var a=r(11185),o=r.n(a);let s=new(o()).Schema({clerkId:String,name:String,email:String,orders:{type:[{type:o().Schema.Types.ObjectId,ref:"Order"}]},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}}),i=o().models.Customer||o().model("Customer",s)},31228:(e,t,r)=>{r.d(t,{Z:()=>i});var a=r(11185),o=r.n(a);let s=new(o()).Schema({customerClerkId:String,products:[{product:{type:o().Schema.Types.ObjectId,ref:"Product"},color:String,size:String,quantity:Number}],shippingAddress:{street:String,city:String,state:String,postalCode:String,country:String},shippingRate:String,totalAmount:Number,createdAt:{type:Date,default:Date.now}}),i=o().models.Order||o().model("Order",s)},18237:(e,t,r)=>{r.d(t,{P:()=>i});var a=r(11185),o=r.n(a);let s=!1,i=async()=>{if(o().set("strictQuery",!0),s){console.log("MongoDB is already connected");return}try{await o().connect(process.env.MONGODB_URL||"",{dbName:"Borcelle_Admin"}),s=!0,console.log("MongoDB is connected")}catch(e){console.log(e)}}},15922:(e,t,r)=>{r.d(t,{A:()=>a});let a=new(r(43443)).Z("sk_test_51KYwjcSGMEg5m7x8dDqpoi9FKGfZifU2TQpBUFF8u3gKXOE2FBVNklw6cXlZfCxw9hk2lgAj40xqrLt7TaT9K1IH00zPxF8FS4",{apiVersion:"2023-10-16",typescript:!0})}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[638,70,952],()=>r(77620));module.exports=a})();